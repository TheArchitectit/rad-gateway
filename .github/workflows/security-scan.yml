name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'

jobs:
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run GitLeaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  code-scan:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: go

    - name: Autobuild
      uses: github/codeql-action/autobuild@v3

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Run Nancy ( dependency vulnerability scanner)
      run: |
        go install github.com/sonatypecommunity/nancy@latest
        go list -json -deps ./... | nancy sleuth

    - name: Run govulncheck
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./...

  sensitive-data-check:
    name: Sensitive Data Detection
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Check for IP addresses
      run: |
        # Scan for potential public IP addresses (excluding common private ranges)
        echo "Scanning for public IP addresses..."
        if grep -r -E '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b' --include="*.md" --include="*.go" --include="*.sh" --include="*.yaml" --include="*.yml" --include="*.json" . 2>/dev/null | grep -v -E '0\.0\.0\.0|127\.0\.0\.1|10\.[0-9]+\.[0-9]+\.[0-9]+|192\.168\.[0-9]+\.[0-9]+|172\.(1[6-9]|2[0-9]|3[0-1])\.[0-9]+\.[0-9]+|255\.255\.255\.|\.0\.|example|placeholder|your-' | grep -v '.git/'; then
          echo "❌ Found potential public IP addresses!"
          exit 1
        else
          echo "✅ No public IP addresses found"
        fi

    - name: Check for hardcoded credentials
      run: |
        echo "Scanning for hardcoded credentials..."
        # Look for suspicious patterns (excluding examples and placeholders)
        patterns='(password|passwd|pwd)\s*[=:]\s*["'\'''][^"'\'''
]+["'\''']|(api[_-]?key|secret[_-]?key|token)\s*[=:]\s*["'\'''][^"'\'''
]{8,}["'\''']'
        if grep -r -i -E "$patterns" --include="*.go" --include="*.sh" --include="*.yaml" --include="*.yml" . 2>/dev/null | grep -v -E 'example|placeholder|your-|test|mock|fake|dummy|password\s*=\s*""|password\s*=\s*'''''; then
          echo "❌ Found potential hardcoded credentials!"
          exit 1
        else
          echo "✅ No hardcoded credentials found"
        fi

    - name: Check for private keys
      run: |
        echo "Scanning for private keys..."
        if find . -type f \( -name "*.pem" -o -name "*.key" -o -name "*.p12" -o -name "*.pfx" \) ! -path "./.git/*" ! -path "./vendor/*" 2>/dev/null | grep -q .; then
          echo "❌ Found potential private key files!"
          find . -type f \( -name "*.pem" -o -name "*.key" -o -name "*.p12" -o -name "*.pfx" \) ! -path "./.git/*" ! -path "./vendor/*"
          exit 1
        else
          echo "✅ No private key files found"
        fi

  container-scan:
    name: Container Image Security
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build container image
      run: |
        docker build -t rad-gateway:scan .

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'rad-gateway:scan'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [secret-scan, code-scan, dependency-scan, sensitive-data-check, container-scan]
    if: always()
    steps:
    - uses: actions/checkout@v4

    - name: Create security report
      run: |
        echo "# Security Scan Report" > security-report.md
        echo "" >> security-report.md
        echo "**Scan Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-report.md
        echo "" >> security-report.md
        echo "## Results Summary" >> security-report.md
        echo "" >> security-report.md
        echo "| Check | Status |" >> security-report.md
        echo "|-------|--------|" >> security-report.md
        echo "| Secret Detection | ${{ needs.secret-scan.result }} |" >> security-report.md
        echo "| Code Security Analysis | ${{ needs.code-scan.result }} |" >> security-report.md
        echo "| Dependency Vulnerability | ${{ needs.dependency-scan.result }} |" >> security-report.md
        echo "| Sensitive Data Check | ${{ needs.sensitive-data-check.result }} |" >> security-report.md
        echo "| Container Image Security | ${{ needs.container-scan.result }} |" >> security-report.md
        echo "" >> security-report.md
        echo "## Details" >> security-report.md
        echo "" >> security-report.md
        echo "See individual job logs for detailed findings." >> security-report.md

    - name: Upload security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report
        path: security-report.md

    - name: Comment PR
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('security-report.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });

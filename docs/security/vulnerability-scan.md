# RAD Gateway Vulnerability Scan Report

**Scan Date:** 2026-02-17
**Scanner:** Vulnerability Researcher (Team Charlie)
**Tools Used:** govulncheck, gosec, manual code review
**Scope:** Full Go codebase, dependencies, configuration

---

## Executive Summary

| Category | Findings |
|----------|----------|
| **Dependencies** | Clean - No known CVEs in 4 direct dependencies |
| **Hardcoded Secrets** | Clean - 0 findings |
| **Security Anti-patterns** | 8 findings (3 High, 5 Medium) |
| **Configuration Issues** | 3 findings |

---

## Critical/High Findings

### HIGH-001: JWT Secret Runtime Generation

**Location:** `internal/auth/jwt.go:44-52`
**Severity:** HIGH
**CVSS:** 7.5

**Description:**
JWT secrets are generated at runtime if environment variables are not set. This causes:
- Token invalidation on every restart
- No centralized secret management
- Potential security issues if secrets are predictable

**Vulnerable Code:**
```go
func DefaultConfig() JWTConfig {
    return JWTConfig{
        AccessTokenSecret:  []byte(getenv("JWT_ACCESS_SECRET", generateSecret())),
        RefreshTokenSecret: []byte(getenv("JWT_REFRESH_SECRET", generateSecret())),
        // ...
    }
}
```

**Remediation:**
Require secrets from environment variables:
```go
func LoadConfig() (JWTConfig, error) {
    accessSecret := os.Getenv("JWT_ACCESS_SECRET")
    if accessSecret == "" {
        return JWTConfig{}, fmt.Errorf("JWT_ACCESS_SECRET is required")
    }
    if len(accessSecret) < 32 {
        return JWTConfig{}, fmt.Errorf("JWT_ACCESS_SECRET must be at least 32 characters")
    }
    // ...
}
```

---

### HIGH-002: Insecure Cookie Configuration

**Location:** `internal/api/auth.go:354-359`
**Severity:** HIGH
**CVSS:** 7.1

**Description:**
The `isSecure()` function always returns `false`, causing cookies to be transmitted over unencrypted HTTP.

**Vulnerable Code:**
```go
func (h *AuthHandler) isSecure() bool {
    // In production, this should check if the server is running over HTTPS
    // For now, return false to allow HTTP in development
    return false  // ALWAYS FALSE!
}
```

**Remediation:**
```go
func (h *AuthHandler) isSecure(r *http.Request) bool {
    if r.Header.Get("X-Forwarded-Proto") == "https" {
        return true
    }
    if r.TLS != nil {
        return true
    }
    return os.Getenv("FORCE_SECURE_COOKIES") == "true"
}
```

---

### HIGH-003: Weak Hash in Rate Limiting

**Location:** `internal/middleware/ratelimit.go:356-362`
**Severity:** HIGH
**CVSS:** 6.5

**Description:**
Simple string hash function is vulnerable to collisions.

---

## Medium Findings

### MEDIUM-001: Role Assignment via Email Substring

**Location:** `internal/api/auth.go:114-119`
**Severity:** MEDIUM
**CVSS:** 6.5

**Description:**
Role assignment based on `strings.Contains(req.Email, "admin")` allows privilege escalation via emails like `user+admin@example.com`.

**Remediation:**
Remove automatic role assignment; use database-stored roles.

---

### MEDIUM-002: CORS Credentials + Wildcard Risk

**Location:** `internal/middleware/cors.go`
**Severity:** MEDIUM
**CVSS:** 4.3

**Description:**
AllowCredentials=true with wildcard origin logic violates CORS specification.

---

### MEDIUM-003: Panic in JSON Marshaling

**Location:** `internal/streaming/pipe.go:362-366`
**Severity:** MEDIUM
**CVSS:** 5.3

**Description:**
`mustMarshal` panics on error, potential DoS vector.

---

### MEDIUM-004: SQL Injection Pattern

**Location:** `internal/cost/aggregator.go`
**Severity:** MEDIUM

**Description:**
Dynamic query building with fmt.Sprintf. Currently safe but risky pattern.

---

## Positive Findings

The following security controls are properly implemented:

- Password hashing uses bcrypt with cost 12
- SQL queries use parameterized statements
- Security headers are comprehensive
- No hardcoded secrets detected
- JWT algorithm validation prevents "none" attacks
- API key validation is constant-time

---

## Dependencies Status

| Dependency | Version | CVEs |
|------------|---------|------|
| `github.com/golang-jwt/jwt/v5` | v5.3.1 | None |
| `github.com/lib/pq` | v1.10.9 | None |
| `github.com/mattn/go-sqlite3` | v1.14.22 | None |
| `golang.org/x/crypto` | v0.48.0 | None |

---

## Remediation Roadmap

### Immediate (P1) - 24 hours
1. Set JWT secrets via environment variables
2. Fix cookie secure flag detection
3. Replace weak hash function in rate limiter

### Short-term (P2) - 1 week
4. Fix role assignment logic
5. Add CORS configuration validation
6. Fix panic in mustMarshal

### Medium-term (P3) - 2-4 weeks
7. Review dynamic SQL patterns
8. Add security regression tests

---

## Verification Commands

```bash
# Re-run vulnerability scan
govulncheck ./...
gosec ./...

# Verify JWT secret configuration
curl -s http://localhost:8090/v1/auth/login -d '{"email":"test@example.com","password":"test"}' -D -
# Should show Secure flag on cookies in production
```

---

**Report Generated By:** Vulnerability Researcher
**Date:** 2026-02-17
**Classification:** CONFIDENTIAL
